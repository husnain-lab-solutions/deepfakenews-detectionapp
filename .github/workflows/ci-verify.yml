name: Full Stack Verification

permissions:
  contents: read
  actions: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  verify:
    runs-on: windows-latest
    env:
      JWT_KEY: ${{ secrets.JWT_KEY }}
    timeout-minutes: 30
    steps:
      - name: Full stack (start ML+Web, verify, cleanup)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference='Stop'
          Write-Host '--- Phase 1: Checkout & Environment ---'
          # Checkout already performed by actions/checkout pre-step insertion; ensure JWT
          if(-not $env:JWT_KEY -or $env:JWT_KEY.Trim().Length -lt 16){
            $rng=[System.Security.Cryptography.RandomNumberGenerator]::Create();
            $b=New-Object byte[] 32; $rng.GetBytes($b);
            $k=[Convert]::ToBase64String($b); echo "JWT_KEY=$k" >> $env:GITHUB_ENV; Write-Host 'JWT_KEY generated for this run.'
          } else { Write-Host 'JWT_KEY loaded from repository secret.' }

          Write-Host '--- Phase 2: Setup Toolchains ---'
          # .NET and Python setup handled by previous composite steps; this single step assumes they are present.

          Write-Host '--- Phase 3: Start ML Service (foreground within step) ---'
          cd ml_service
          if(-not (Test-Path .\.venv\Scripts\Activate.ps1)){ python -m venv .venv }
          . .\.venv\Scripts\Activate.ps1
          python -m pip install --upgrade pip | Out-Null
          python -m pip install fastapi uvicorn pillow python-multipart | Out-Null
          $mlOut='uvicorn.out.log'; $mlErr='uvicorn.err.log'
          if(Test-Path $mlOut){ Remove-Item $mlOut -Force }
            if(Test-Path $mlErr){ Remove-Item $mlErr -Force }
          Write-Host 'Launching uvicorn...' -ForegroundColor Cyan
          $mlProc = Start-Process python -ArgumentList '-m','uvicorn','app:app','--host','127.0.0.1','--port','8000','--log-level','info' -RedirectStandardOutput $mlOut -RedirectStandardError $mlErr -PassThru -WorkingDirectory (Get-Location)
          echo $mlProc.Id > uvicorn.pid
          $deadline=(Get-Date).AddSeconds(120); $healthy=$false
          while((Get-Date)-lt $deadline){
            try { $r=Invoke-RestMethod -Uri http://127.0.0.1:8000/health -TimeoutSec 5 -ErrorAction Stop; if($r.status -eq 'OK'){ $healthy=$true; break } } catch {}
            Start-Sleep 3
          }
          if(-not $healthy){
            Write-Host 'ML health failed; printing logs.' -ForegroundColor Red
            Get-Content $mlErr -ErrorAction SilentlyContinue | Select-Object -Last 80
            Get-Content $mlOut -ErrorAction SilentlyContinue | Select-Object -Last 80
            throw 'ML service failed to become healthy.'
          }
          Write-Host 'ML service healthy.' -ForegroundColor Green

          Write-Host '--- Phase 4: Build & Start Web App ---'
          cd ..\WebApplication1
          dotnet build --configuration Debug
          $env:ASPNETCORE_URLS='http://localhost:5140'
          $webProc = Start-Process dotnet -ArgumentList 'run --no-launch-profile' -PassThru
          echo $webProc.Id > ..\webapp.pid
          $deadline=(Get-Date).AddSeconds(90)
          while((Get-Date)-lt $deadline){ if(Test-NetConnection -ComputerName localhost -Port 5140 -InformationLevel Quiet){ break }; Start-Sleep 2 }
          if(-not (Test-NetConnection -ComputerName localhost -Port 5140 -InformationLevel Quiet)){ throw 'Web app failed to open port 5140.' }
          try { $root = Invoke-WebRequest -UseBasicParsing -Uri 'http://localhost:5140/' -TimeoutSec 10; Write-Host "Root status: $($root.StatusCode)" } catch { Write-Host 'Root probe failed' -ForegroundColor Yellow }

          Write-Host '--- Phase 5: Run Verification ---'
          cd ..\scripts
          try {
            ./verify_full_stack.ps1
            $verifyExit=$LASTEXITCODE
          } catch {
            Write-Host "Verifier exception: $($_.Exception.Message)" -ForegroundColor Red
            $verifyExit=1
          }
          if($verifyExit -ne 0){
            Write-Host 'Tail ML logs (err/out) due to failure:' -ForegroundColor Yellow
            Get-Content ..\ml_service\uvicorn.err.log -ErrorAction SilentlyContinue | Select-Object -Last 80
            Get-Content ..\ml_service\uvicorn.out.log -ErrorAction SilentlyContinue | Select-Object -Last 80
          }

          Write-Host '--- Phase 6: Summary Artifact ---'
          if(Test-Path sample_image.png){ Write-Host 'Sample image created.' }
          Get-ChildItem -File | Select-Object Name,Length

          Write-Host '--- Phase 7: Cleanup ---'
          cd ..
          if(Test-Path webapp.pid){ $wp=Get-Content webapp.pid | Select-Object -First 1; try { Stop-Process -Id $wp -Force -ErrorAction SilentlyContinue } catch {} }
          if(Test-Path ml_service\uvicorn.pid){ $mp=Get-Content ml_service\uvicorn.pid | Select-Object -First 1; try { Stop-Process -Id $mp -Force -ErrorAction SilentlyContinue } catch {} }

          if($verifyExit -ne 0){ exit $verifyExit } else { Write-Host 'Done (verification succeeded).' -ForegroundColor Green }
